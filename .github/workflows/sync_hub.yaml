name: Sync Public Workflows to Hub

on:
  push:
    branches:
      - main

  workflow_dispatch:
  #schedule:
    # Run hourly
    #- cron: '0 * * * *'

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.set-matrix.outputs.repos }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate matrix from workflow_repos.txt
        id: set-matrix
        run: |
          repos_json=$(jq -c -R -s 'split("\n") | map(select(length > 0))' workflow_repos.txt)
          echo "repos=${repos_json}" >> $GITHUB_OUTPUT

  sync-to-hub:
    needs: generate-matrix
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJSON(needs.generate-matrix.outputs.repos) }}
    steps:
      - name: Generate token from GitHub App
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.HUB_APP_ID }}
          private-key: ${{ secrets.HUB_APP_PRIVATE_KEY }}

      - name: Checkout repository ${{ matrix.repo }}
        uses: actions/checkout@v4
        with:
          repository: UKHomeOffice/${{ matrix.repo }}
          token: ${{ steps.generate-token.outputs.token }}
          path: ${{ matrix.repo }}
          fetch-depth: 0

      - name: Debug token permissions
        env:
          APP_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          echo "Token info:"
          curl -s -H "Authorization: token $APP_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/user" | jq '.'
    
          echo "Repository permissions:"
          curl -s -H "Authorization: token $APP_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/<org-name>/${{ matrix.repo }}" | \
            jq '.permissions'

      - name: Mirror ${{ matrix.repo }} to Hub Repo
        env:
          # The token generated by the create-github-app-token action
          APP_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          cd ${{ matrix.repo }}
          git push --mirror "https://x-access-token:${{ env.APP_TOKEN }}@github.com/UKHomeOffice/${{ matrix.repo }}.git"

      - name: Mirror ${{ matrix.repo }} to Hub Repo
        env:
          APP_TOKEN: ${{ steps.generate-token.outputs.token }}
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          gh api octocat
          echo "Mirroring ${{ matrix.repo }} to the Hub repo..."
          cd ${{ matrix.repo }}
          git config --global credential.helper store
          echo "https://x-access-token:${{ env.APP_TOKEN }}@github.com" > ~/.git-credentials
          git push --mirror https://github.com/UKHomeOffice/${{ matrix.repo }}.git
